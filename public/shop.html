<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Feature Shop - Zeropoint</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111827;
      color: #e5e7eb;
      margin: 0;
      padding: 0;
    }

    header {
      background: #1f2937;
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #374151;
    }

    header h1 {
      margin: 0;
      font-size: 1.3rem;
      color: #f9fafb;
    }

    header a {
      color: #60a5fa;
      text-decoration: none;
      font-size: 0.9rem;
    }

    main {
      max-width: 900px;
      margin: 1.5rem auto 2rem;
      padding: 0 1rem;
    }

    .summary-card {
      background: #111827;
      border: 1px solid #374151;
      border-radius: 0.75rem;
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .summary-label {
      font-size: 0.9rem;
      color: #9ca3af;
    }

    .summary-value {
      font-size: 1rem;
      color: #f9fafb;
      font-weight: 600;
    }

    .status {
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }

    .status.ok {
      color: #6ee7b7;
    }

    .status.err {
      color: #fca5a5;
    }

    h2 {
      font-size: 1.1rem;
      margin: 1.25rem 0 0.75rem;
      color: #e5e7eb;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
    }

    .feature-card {
      background: #020617;
      border-radius: 0.75rem;
      padding: 1rem;
      border: 1px solid #1f2937;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 170px;
    }

    .feature-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: #f9fafb;
    }

    .feature-price {
      font-size: 0.95rem;
      color: #facc15;
      margin-bottom: 0.4rem;
    }

    .feature-desc {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-bottom: 0.75rem;
    }

    .feature-status {
      font-size: 0.85rem;
      margin-bottom: 0.75rem;
    }

    .feature-status.unlocked {
      color: #6ee7b7;
    }

    .feature-status.locked {
      color: #f97316;
    }

    button {
      cursor: pointer;
      border-radius: 999px;
      border: none;
      padding: 0.5rem 0.9rem;
      font-size: 0.9rem;
      font-weight: 500;
      transition: background 0.15s, opacity 0.15s, transform 0.05s;
    }

    button.primary {
      background: #2563eb;
      color: white;
    }

    button.primary:hover {
      background: #1d4ed8;
      transform: translateY(-1px);
    }

    button.secondary {
      background: #374151;
      color: #e5e7eb;
    }

    button.secondary:hover {
      background: #4b5563;
    }

    button[disabled] {
      opacity: 0.6;
      cursor: default;
      transform: none;
    }

    footer {
      text-align: center;
      font-size: 0.8rem;
      color: #6b7280;
      padding-bottom: 1.5rem;
      margin-top: 1.5rem;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .badge.banned {
      background: rgba(248, 113, 113, 0.1);
      color: #fecaca;
      border: 1px solid rgba(248, 113, 113, 0.4);
    }

    .badge.ok {
      background: rgba(52, 211, 153, 0.1);
      color: #a7f3d0;
      border: 1px solid rgba(52, 211, 153, 0.4);
    }
  </style>
</head>
<body>
  <header>
    <h1>Feature Shop</h1>
    <nav>
      <a href="/account">Back to Account</a>
    </nav>
  </header>

  <main>
    <section class="summary-card">
      <div class="summary-row">
        <div>
          <div class="summary-label">Logged in as</div>
          <div class="summary-value" id="username">-</div>
        </div>
        <div>
          <div class="summary-label">Coins</div>
          <div class="summary-value" id="coins">-</div>
        </div>
        <div>
          <div class="summary-label">Account</div>
          <div class="summary-value">
            <span id="role">-</span>
            <span style="font-size:0.8rem;color:#9ca3af;">(Level <span id="level">-</span>)</span>
          </div>
        </div>
      </div>
      <div class="summary-row">
        <div>
          <div class="summary-label">Coin usage status</div>
          <div id="coinStatus"></div>
        </div>
      </div>
      <div id="globalStatus" class="status"></div>
    </section>

    <section>
      <h2>Available Features</h2>
      <div class="grid" id="featureGrid">
        <!-- Cards injected by JS -->
      </div>
    </section>

    <footer>
      All purchases are permanent unlocks for this account. Coins are non-refundable.
    </footer>
  </main>

  <script>
    const FEATURE_DEFS = [
      {
        key: "chat",
        title: "Direct Messages",
        price: 100,
        desc: "Unlock 1:1 direct messages so you can chat privately with friends."
      },
      {
        key: "groupChat",
        title: "Join Group Chats",
        price: 200,
        desc: "Unlock the ability to participate in existing group chats."
      },
      {
        key: "createGroup",
        title: "Create Group Chats",
        price: 300,
        desc: "Create your own group chat rooms and invite other users."
      },
      {
        key: "imageUpload",
        title: "Image Upload",
        price: 150,
        desc: "Send images in chat. Please follow all community guidelines."
      }
    ];

    let state = {
      username: null,
      coins: 0,
      role: null,
      level: 1,
      bans: {},
      unlocks: {}
    };

    function setStatus(msg, isError = false) {
      const el = document.getElementById("globalStatus");
      el.textContent = msg || "";
      el.className = "status" + (msg ? (isError ? " err" : " ok") : "");
    }

    async function loadMe() {
      try {
        const res = await fetch("/api/coins/me", { credentials: "include" });
        if (!res.ok) {
          setStatus("Failed to load account info", true);
          return;
        }
        const data = await res.json();
        state.username = data.username;
        state.coins = data.coins;
        state.role = data.role;
        state.level = data.level;
        state.bans = data.bans || {};
        state.unlocks = data.unlocks || {};

        document.getElementById("username").textContent = state.username || "-";
        document.getElementById("coins").textContent = state.coins ?? "-";
        document.getElementById("role").textContent = state.role ?? "-";
        document.getElementById("level").textContent = state.level ?? "-";

        const coinStatus = document.getElementById("coinStatus");
        if (state.bans && state.bans.isBannedFromCoins) {
          coinStatus.innerHTML =
            '<span class="badge banned">COIN BANNED</span> ' +
            (state.bans.reason ? `<span style="margin-left:0.5rem;color:#fecaca;">${state.bans.reason}</span>` : "");
        } else {
          coinStatus.innerHTML = '<span class="badge ok">COINS ALLOWED</span>';
        }

        renderFeatures();
      } catch (err) {
        console.error(err);
        setStatus("Error loading account info", true);
      }
    }

    function renderFeatures() {
      const grid = document.getElementById("featureGrid");
      grid.innerHTML = "";

      const bannedFromCoins = !!(state.bans && state.bans.isBannedFromCoins);

      FEATURE_DEFS.forEach((f) => {
        const unlocked = !!(state.unlocks && state.unlocks[f.key]);
        const canAfford = state.coins >= f.price;
        const disabled = unlocked || bannedFromCoins || !canAfford;

        const card = document.createElement("div");
        card.className = "feature-card";

        card.innerHTML = `
          <div>
            <div class="feature-title">${f.title}</div>
            <div class="feature-price">${f.price.toLocaleString()} coins</div>
            <div class="feature-desc">${f.desc}</div>
            <div class="feature-status ${unlocked ? "unlocked" : "locked"}">
              ${unlocked ? "Already unlocked âœ“" : "Locked"}
            </div>
          </div>
          <div>
            <button
              class="primary"
              data-key="${f.key}"
              ${disabled ? "disabled" : ""}
            >
              ${unlocked ? "Unlocked" : "Buy"}
            </button>
          </div>
        `;

        grid.appendChild(card);
      });

      grid.querySelectorAll("button[data-key]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const key = btn.getAttribute("data-key");
          buyFeature(key);
        });
      });
    }

    async function buyFeature(featureKey) {
      setStatus("");
      try {
        const res = await fetch("/api/coins/buy-feature", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ featureKey })
        });

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          setStatus(data.error || "Purchase failed", true);
          return;
        }

        const data = await res.json();
        state.coins = data.coins;
        state.unlocks = data.unlocks || state.unlocks;

        document.getElementById("coins").textContent = state.coins;
        setStatus("Feature unlocked successfully!");
        renderFeatures();
      } catch (err) {
        console.error(err);
        setStatus("Error while purchasing feature", true);
      }
    }

    loadMe();
  </script>
</body>
</html>