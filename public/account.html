<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>My Page • ZeroPoint</title>
  <link rel="stylesheet" href="/app.css"/>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="topbar">
        <div class="brand">MY PAGE</div>
        <div class="pills">
          <a class="pill" href="/">HOME</a>
          <button class="pill danger" id="logoutBtn" type="button">LOGOUT</button>
        </div>
      </div>

      <div class="formWrap">
        <div class="card">
          <h1>Account</h1>
          <div id="meBox" class="msg" style="display:none"></div>
          <div id="msg" class="msg" style="display:none"></div>
        </div>

        <div class="card">
          <h2>Change username</h2>
          <label>New username</label>
          <input class="text" id="newUsername" />
          <label>Current password</label>
          <input class="text" id="curPass1" type="password" autocomplete="current-password" />
          <button class="btn primary" id="changeUsernameBtn" type="button" style="margin-top:12px">Change username</button>
        </div>

        <div class="card">
          <h2>Change password</h2>
          <label>Current password</label>
          <input class="text" id="curPass2" type="password" autocomplete="current-password" />
          <label>New password</label>
          <input class="text" id="newPass" type="password" autocomplete="new-password" />
          <label>Confirm new password</label>
          <input class="text" id="newPass2" type="password" autocomplete="new-password" />
          <button class="btn primary" id="changePasswordBtn" type="button" style="margin-top:12px">Change password</button>
        </div>

        <div class="card">
          <h2>Apply for role upgrade</h2>
          <div class="msg warn">
            You can request an upgrade. An admin must approve it on the <b>/admin</b> page.
          </div>
          <label>Requested role</label>
          <select class="text" id="roleSelect">
            <option value="mod">mod</option>
            <option value="admin">admin</option>
          </select>
          <button class="btn warn" id="applyRoleBtn" type="button" style="margin-top:12px">Send request</button>
          <div class="msg" id="reqHint" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const logoutBtn = document.getElementById("logoutBtn");
  const meBox = document.getElementById("meBox");
  const msg = document.getElementById("msg");

  const newUsername = document.getElementById("newUsername");
  const curPass1 = document.getElementById("curPass1");
  const changeUsernameBtn = document.getElementById("changeUsernameBtn");

  const curPass2 = document.getElementById("curPass2");
  const newPass = document.getElementById("newPass");
  const newPass2 = document.getElementById("newPass2");
  const changePasswordBtn = document.getElementById("changePasswordBtn");

  const roleSelect = document.getElementById("roleSelect");
  const applyRoleBtn = document.getElementById("applyRoleBtn");
  const reqHint = document.getElementById("reqHint");

  function showBox(el, type, text) {
    el.style.display = "";
    el.className = "msg " + (type || "");
    el.textContent = text;
  }

  async function getMe() {
    const res = await fetch("/api/auth/me", { credentials: "include" });
    return res.json();
  }

  async function api(path, body) {
    const res = await fetch(path, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify(body)
    });
    const data = await res.json().catch(()=> ({}));
    if (!res.ok) throw new Error(data.error || ("Request failed: " + res.status));
    return data;
  }

  async function init() {
    const me = await getMe();
    if (!me.loggedIn) {
      location.href = "/login?next=/account";
      return;
    }
    showBox(meBox, "ok", `Logged in as ${me.user.username} • role=${me.user.role}`);
  }

  logoutBtn.addEventListener("click", async () => {
    try { await api("/api/auth/logout", {}); } catch {}
    location.href = "/";
  });

  changeUsernameBtn.addEventListener("click", async () => {
    try {
      showBox(msg, "", "Updating username…");
      const out = await api("/api/account/change-username", {
        newUsername: newUsername.value,
        currentPassword: curPass1.value
      });
      showBox(msg, "ok", "Username changed to: " + out.user.username);
      await init();
    } catch (e) {
      showBox(msg, "danger", e.message);
    }
  });

  changePasswordBtn.addEventListener("click", async () => {
    try {
      if (newPass.value !== newPass2.value) {
        showBox(msg, "warn", "New passwords do not match.");
        return;
      }
      showBox(msg, "", "Updating password…");
      await api("/api/account/change-password", {
        currentPassword: curPass2.value,
        newPassword: newPass.value
      });
      showBox(msg, "ok", "Password changed.");
      curPass2.value = "";
      newPass.value = "";
      newPass2.value = "";
    } catch (e) {
      showBox(msg, "danger", e.message);
    }
  });

  applyRoleBtn.addEventListener("click", async () => {
    try {
      reqHint.style.display = "none";
      showBox(msg, "", "Sending request…");
      const out = await api("/api/requests/role", { role: roleSelect.value });
      showBox(msg, "ok", "Request sent. Waiting for admin approval.");
      showBox(reqHint, "warn", "Request ID: " + out.request.id);
    } catch (e) {
      showBox(msg, "danger", e.message);
    }
  });

  init();
})();
</script>
</body>
</html>
