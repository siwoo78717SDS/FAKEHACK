<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin</title>
  <style>
    body{margin:0;background:#02060c;color:#eaffee;font-family:ui-monospace,Consolas,monospace}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .card{border:1px solid rgba(0,255,160,.35);border-radius:14px;padding:14px;background:rgba(0,0,0,.35);margin:12px 0}
    h1{margin:0 0 8px;letter-spacing:.14em;text-transform:uppercase;color:#7df3ff}
    h2{margin:0 0 10px;font-size:13px;letter-spacing:.12em;text-transform:uppercase;color:#9bffd4}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,247,255,.22);background:rgba(0,0,0,.35);color:#eaffee;outline:none}
    button{padding:10px 14px;border-radius:12px;border:1px solid rgba(0,255,160,.55);background:rgba(0,0,0,.55);color:#eaffee;cursor:pointer}
    button:hover{border-color:rgba(0,247,255,.7)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{padding:4px 10px;border-radius:999px;border:1px solid rgba(0,247,255,.35);font-size:12px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(0,247,255,.12);padding:8px;text-align:left;font-size:12px;vertical-align:top}
    .muted{opacity:.75}
    .danger{color:#ff4c4c}
    .ok{color:#30ff9b}
    .right{margin-left:auto}
    .small{padding:8px 10px;border-radius:10px;font-size:12px}
    pre{white-space:pre-wrap;margin:0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row">
      <h1>Admin Panel</h1>
      <span class="pill" id="authPill">auth: checking…</span>
      <button class="small right" onclick="location.href='/'">Home</button>
      <button class="small" id="logoutBtn">Logout</button>
    </div>

    <div class="card">
      <h2>Broadcast log to everyone online</h2>
      <div class="row">
        <input id="broadcastMsg" placeholder="Message to all online sessions…" />
        <button id="broadcastBtn">Broadcast</button>
      </div>
      <div class="muted" style="margin-top:8px">
        This uses SSE connections (a “device” here means a browser tab connected to your site).
      </div>
    </div>

    <div class="card">
      <h2>Send to a specific device/session</h2>
      <div class="row">
        <select id="connSelect"></select>
        <input id="oneMsg" placeholder="Message to selected session…" />
        <button id="oneBtn">Send</button>
        <button id="refreshConnBtn">Refresh</button>
      </div>
      <div class="muted" style="margin-top:8px">
        You can message a single connection id (target tab/device).
      </div>
    </div>

    <div class="card">
      <h2>Site controls</h2>
      <div class="row">
        <button id="maintenanceToggleBtn">Maintenance: …</button>
        <input id="announcementInput" placeholder="Announcement shown on homepage (optional)" />
        <button id="announcementBtn">Set announcement</button>
      </div>
    </div>

    <div class="card">
      <h2>Applications (mod/admin)</h2>
      <button id="loadAppsBtn">Load applications</button>
      <table style="margin-top:10px">
        <thead>
          <tr>
            <th>ID</th><th>User</th><th>Requested</th><th>Message</th><th>Status</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="appsTbody">
          <tr><td colspan="6" class="muted">No data.</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <h2>Users</h2>
      <div class="row">
        <input id="search" placeholder="Search username/email/name (optional)" />
        <button id="loadUsersBtn">Load users</button>
      </div>

      <table style="margin-top:10px">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Username</th>
            <th>Role</th>
            <th>Banned</th>
            <th>Masked IP</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="usersTbody">
          <tr><td colspan="8" class="muted">No data.</td></tr>
        </tbody>
      </table>
      <div class="muted" style="margin-top:8px">
        Note: IPs are masked for privacy. Bans are by account (safer + more reliable).
      </div>
    </div>

    <div class="card">
      <h2>Audit log</h2>
      <button id="loadAuditBtn">Load audit</button>
      <pre id="audit" class="muted" style="margin-top:10px">No data.</pre>
    </div>
  </div>

<script>
  const authPill = document.getElementById("authPill");
  const logoutBtn = document.getElementById("logoutBtn");

  const connSelect = document.getElementById("connSelect");
  const refreshConnBtn = document.getElementById("refreshConnBtn");
  const broadcastMsg = document.getElementById("broadcastMsg");
  const broadcastBtn = document.getElementById("broadcastBtn");
  const oneMsg = document.getElementById("oneMsg");
  const oneBtn = document.getElementById("oneBtn");

  const maintenanceToggleBtn = document.getElementById("maintenanceToggleBtn");
  const announcementInput = document.getElementById("announcementInput");
  const announcementBtn = document.getElementById("announcementBtn");

  const loadUsersBtn = document.getElementById("loadUsersBtn");
  const usersTbody = document.getElementById("usersTbody");
  const search = document.getElementById("search");

  const loadAppsBtn = document.getElementById("loadAppsBtn");
  const appsTbody = document.getElementById("appsTbody");

  const loadAuditBtn = document.getElementById("loadAuditBtn");
  const audit = document.getElementById("audit");

  async function api(path, opts = {}) {
    const res = await fetch(path, {
      ...opts,
      headers: { "Content-Type": "application/json", ...(opts.headers || {}) },
      credentials: "include"
    });
    const data = await res.json().catch(()=>({}));
    return { res, data };
  }

  function setAuth(ok, txt){
    authPill.textContent = txt;
    authPill.style.borderColor = ok ? "rgba(48,255,155,.6)" : "rgba(255,180,0,.6)";
    authPill.style.color = ok ? "#9bffd4" : "#ffd580";
  }

  async function requireAdmin(){
    const {res, data} = await api("/api/me");
    if(!res.ok){ location.href="/login"; return null; }
    if(data.role !== "admin"){
      setAuth(false, "auth: forbidden");
      document.body.innerHTML = "<pre style='padding:18px;color:#ff4c4c'>403 Forbidden (admin only)</pre>";
      return null;
    }
    setAuth(true, `auth: admin (${data.username})`);
    return data;
  }

  function esc(s){ return String(s??"").replaceAll("&","&amp;").replaceAll("<","<").replaceAll(">",">"); }

  async function refreshConnections(){
    const {res, data} = await api("/api/admin/online");
    if(!res.ok){ alert("Failed to load online list"); return; }
    const list = data.connections || [];
    connSelect.innerHTML = list.length
      ? list.map(c => `<option value="${esc(c.id)}">${esc(c.id)} — ${esc(c.userLabel)} — ${esc(c.uaShort)}</option>`).join("")
      : `<option value="">(no online sessions)</option>`;
  }

  async function refreshSettings(){
    const {res, data} = await api("/api/settings");
    if(res.ok){
      maintenanceToggleBtn.textContent = "Maintenance: " + (data.maintenance ? "ON" : "OFF");
      announcementInput.value = data.announcement || "";
    }
  }

  async function loadUsers(){
    usersTbody.innerHTML = `<tr><td colspan="8" class="muted">Loading…</td></tr>`;
    const q = search.value.trim();
    const {res, data} = await api("/api/admin/users" + (q ? `?search=${encodeURIComponent(q)}` : ""));
    if(!res.ok){
      usersTbody.innerHTML = `<tr><td colspan="8" class="danger">Error ${res.status}</td></tr>`;
      return;
    }
    const users = data.users || [];
    if(!users.length){
      usersTbody.innerHTML = `<tr><td colspan="8" class="muted">No users.</td></tr>`;
      return;
    }
    usersTbody.innerHTML = users.map(u => `
      <tr>
        <td>${esc(u.id)}</td>
        <td>${esc(u.name)}</td>
        <td>${esc(u.email)}</td>
        <td>${esc(u.username)}</td>
        <td>${esc(u.role)}</td>
        <td>${u.banned ? '<span class="danger">YES</span>' : '<span class="ok">NO</span>'}</td>
        <td class="muted">${esc(u.maskedIp || "")}</td>
        <td>
          <div class="row">
            <button class="small" data-act="ban" data-id="${esc(u.id)}">Ban</button>
            <button class="small" data-act="unban" data-id="${esc(u.id)}">Unban</button>
            <button class="small" data-act="logout" data-id="${esc(u.id)}">Force logout</button>
            <button class="small" data-act="role" data-id="${esc(u.id)}" data-role="user">Role user</button>
            <button class="small" data-act="role" data-id="${esc(u.id)}" data-role="mod">Role mod</button>
            <button class="small" data-act="role" data-id="${esc(u.id)}" data-role="admin">Role admin</button>
          </div>
        </td>
      </tr>
    `).join("");
  }

  usersTbody.addEventListener("click", async (e) => {
    const b = e.target.closest("button[data-act]");
    if(!b) return;
    const act = b.dataset.act;
    const userId = b.dataset.id;

    if(act === "ban"){
      const reason = prompt("Ban reason (optional):") || "";
      const {res, data} = await api("/api/admin/ban",{method:"POST", body:JSON.stringify({userId, reason})});
      if(!res.ok) alert(data.message || `Ban failed (${res.status})`);
      await loadUsers();
    }
    if(act === "unban"){
      const {res, data} = await api("/api/admin/unban",{method:"POST", body:JSON.stringify({userId})});
      if(!res.ok) alert(data.message || `Unban failed (${res.status})`);
      await loadUsers();
    }
    if(act === "logout"){
      const {res, data} = await api("/api/admin/force-logout",{method:"POST", body:JSON.stringify({userId})});
      if(!res.ok) alert(data.message || `Force logout failed (${res.status})`);
      else alert("Forced logout (user will be kicked on next request).");
    }
    if(act === "role"){
      const role = b.dataset.role;
      if(!confirm(`Set role to ${role}?`)) return;
      const {res, data} = await api("/api/admin/set-role",{method:"POST", body:JSON.stringify({userId, role})});
      if(!res.ok) alert(data.message || `Set-role failed (${res.status})`);
      await loadUsers();
    }
  });

  async function loadApps(){
    appsTbody.innerHTML = `<tr><td colspan="6" class="muted">Loading…</td></tr>`;
    const {res, data} = await api("/api/admin/applications");
    if(!res.ok){
      appsTbody.innerHTML = `<tr><td colspan="6" class="danger">Error ${res.status}</td></tr>`;
      return;
    }
    const items = data.items || [];
    if(!items.length){
      appsTbody.innerHTML = `<tr><td colspan="6" class="muted">No applications.</td></tr>`;
      return;
    }
    appsTbody.innerHTML = items.map(a => `
      <tr>
        <td>${esc(a.id)}</td>
        <td>${esc(a.username)} (#${esc(a.userId)})</td>
        <td>${esc(a.requestedRole)}</td>
        <td class="muted">${esc(a.message || "")}</td>
        <td>${esc(a.status)}</td>
        <td>
          <div class="row">
            <button class="small" data-app="${esc(a.id)}" data-decision="approve">Approve</button>
            <button class="small" data-app="${esc(a.id)}" data-decision="deny">Deny</button>
          </div>
        </td>
      </tr>
    `).join("");
  }

  appsTbody.addEventListener("click", async (e) => {
    const b = e.target.closest("button[data-app]");
    if(!b) return;
    const appId = b.dataset.app;
    const decision = b.dataset.decision;
    const {res, data} = await api("/api/admin/applications/decide", {
      method:"POST",
      body: JSON.stringify({ appId, decision })
    });
    if(!res.ok) alert(data.message || `Decision failed (${res.status})`);
    await loadApps();
    await loadUsers();
  });

  async function loadAudit(){
    const {res, data} = await api("/api/admin/audit");
    if(!res.ok){ audit.textContent = `Error ${res.status}`; return; }
    const lines = data.lines || [];
    audit.textContent = lines.length ? lines.join("\n") : "No audit yet.";
  }

  broadcastBtn.onclick = async () => {
    const message = broadcastMsg.value.trim();
    if(!message) return;
    broadcastMsg.value = "";
    const {res, data} = await api("/api/admin/broadcast",{method:"POST", body:JSON.stringify({message})});
    if(!res.ok) alert(data.message || `Broadcast failed (${res.status})`);
  };

  oneBtn.onclick = async () => {
    const connId = connSelect.value;
    const message = oneMsg.value.trim();
    if(!connId || !message) return;
    oneMsg.value = "";
    const {res, data} = await api("/api/admin/message",{method:"POST", body:JSON.stringify({connId, message})});
    if(!res.ok) alert(data.message || `Message failed (${res.status})`);
  };

  refreshConnBtn.onclick = refreshConnections;

  maintenanceToggleBtn.onclick = async () => {
    const {res:curRes, data:cur} = await api("/api/settings");
    if(!curRes.ok) return;
    const enabled = !cur.maintenance;
    const {res, data} = await api("/api/admin/maintenance",{method:"POST", body:JSON.stringify({enabled})});
    if(!res.ok) alert(data.message || `Failed (${res.status})`);
    await refreshSettings();
  };

  announcementBtn.onclick = async () => {
    const message = announcementInput.value.trim();
    const {res, data} = await api("/api/admin/announcement",{method:"POST", body:JSON.stringify({message})});
    if(!res.ok) alert(data.message || `Failed (${res.status})`);
    await refreshSettings();
  };

  loadUsersBtn.onclick = loadUsers;
  loadAppsBtn.onclick = loadApps;
  loadAuditBtn.onclick = loadAudit;

  logoutBtn.onclick = async () => {
    await api("/api/logout",{method:"POST"});
    location.href="/login";
  };

  (async () => {
    const me = await requireAdmin();
    if(!me) return;
    await refreshConnections();
    await refreshSettings();
    await loadUsers();
  })();
</script>
</body>
</html>
