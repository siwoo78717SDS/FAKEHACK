<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Moderator Dashboard</title>
    <link rel="stylesheet" href="/app.css" />
    <style>
      .wrap { max-width: 900px; margin: 40px auto; padding: 0 16px; }
      .card {
        border: 1px solid rgba(255,255,255,0.12);
        background: rgba(0,0,0,0.35);
        border-radius: 14px;
        padding: 16px;
        margin-top: 14px;
      }
      .row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
      .btn {
        cursor: pointer;
        border-radius: 10px;
        padding: 10px 12px;
        border: 1px solid rgba(255,255,255,0.16);
        background: rgba(0,0,0,0.45);
        color: #dff;
        text-decoration: none;
        display: inline-block;
      }
      .muted { opacity: 0.8; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Moderator Dashboard</h1>
      <div class="muted" id="meLine">Checking login…</div>

      <div class="card">
        <h3>Quick Links</h3>
        <div class="row">
          <a class="btn" href="/">Home</a>
          <a class="btn" href="/account">My Page</a>
          <button class="btn" id="logoutBtn">Logout</button>
        </div>
      </div>

      <div class="card">
        <h3>Tools (view-only)</h3>
        <p class="muted">
          Option A: moderators cannot approve role requests. Admins do that on /admin.
        </p>

        <div class="row">
          <button class="btn" id="pingBtn">Ping /api/auth/me</button>
        </div>

        <pre class="card" id="out" style="white-space: pre-wrap">Output…</pre>
      </div>
    </div>

    <script>
      const out = document.getElementById("out");
      const meLine = document.getElementById("meLine");

      async function api(path, opts = {}) {
        const res = await fetch(path, {
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          ...opts,
        });
        const ct = res.headers.get("content-type") || "";
        const data = ct.includes("application/json") ? await res.json() : null;
        return { res, data };
      }

      async function init() {
        const { res, data } = await api("/api/auth/me");
        if (!res.ok || !data?.user) return (location.href = "/login");

        const { username, role } = data.user;
        if (role !== "mod" && role !== "admin") {
          alert("You are not a moderator.");
          return (location.href = "/");
        }

        meLine.textContent = `Logged in as ${username} (role: ${role})`;
        out.textContent = "Ready.";
      }

      document.getElementById("logoutBtn").addEventListener("click", async () => {
        await api("/api/auth/logout", { method: "POST", body: "{}" });
        location.href = "/";
      });

      document.getElementById("pingBtn").addEventListener("click", async () => {
        const { res, data } = await api("/api/auth/me");
        out.textContent = res.ok ? JSON.stringify(data, null, 2) : "API error: " + res.status;
      });

      init();
    </script>
  </body>
</html>
