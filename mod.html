<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>NotHack // Mod</title>
    <link rel="stylesheet" href="/theme.css" />
  </head>
  <body>
    <div id="screen">
      <div id="header">
        <div id="title">NOTHACK // MOD</div>
        <div id="subtitle">submit facts • request bans</div>
        <div id="statusBar">
          <span class="status-pill info" id="mePill">Checking login…</span>
          <a class="status-pill ok" href="/index.html">HOME</a>
          <a class="status-pill ok" href="/admin.html">ADMIN</a>
          <button class="small danger" id="logoutBtn">Logout</button>
        </div>
      </div>

      <div id="term">
        <div class="sectionTitle">Submit a fact</div>
        <div class="muted">Sends to POST /api/facts/submit (admin approves later)</div>
        <div style="height:10px;"></div>

        <textarea id="factText" placeholder="Type a fact…"></textarea>
        <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
          <button class="small ok" id="submitFactBtn">Submit Fact</button>
          <span class="muted" id="factStatus"></span>
        </div>

        <hr />

        <div class="sectionTitle">Request a ban</div>
        <div class="muted">Sends to POST /api/mod/ban/request (admin must approve)</div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:10px;">
          <div>
            <label class="muted">Target type</label>
            <select id="banType">
              <option value="user">user</option>
              <option value="ip">ip</option>
            </select>

            <div style="height:10px;"></div>
            <label class="muted">User ID (only if user)</label>
            <input id="banUserId" placeholder="id_..." />

            <div style="height:10px;"></div>
            <label class="muted">IP (only if ip)</label>
            <input id="banIp" placeholder="123.45.67.89" />
          </div>

          <div>
            <label class="muted">Reason</label>
            <textarea id="banReason" placeholder="Explain what happened…"></textarea>

            <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
              <button class="small ok" id="sendBanReqBtn">Send Request</button>
              <span class="muted" id="banStatus"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      function setText(id, msg) { document.getElementById(id).textContent = msg || ""; }

      async function api(path, opts = {}) {
        const r = await fetch(path, {
          credentials: "include",
          headers: { "Content-Type": "application/json", ...(opts.headers || {}) },
          ...opts
        });

        if (r.status === 401) {
          location.href = "/login.html?next=" + encodeURIComponent(location.pathname);
          throw new Error("Not logged in");
        }

        const data = await r.json().catch(() => ({}));
        if (r.status === 403) throw new Error(data.error || "Forbidden");
        if (!r.ok || data.ok === false) throw new Error(data.error || ("Request failed: " + r.status));
        return data;
      }

      async function guardMod() {
        const me = await api("/api/auth/me");
        if (!me.loggedIn) {
          location.href = "/login.html?next=/mod.html";
          return false;
        }
        const role = me.user.role;
        if (role !== "mod" && role !== "admin") {
          document.getElementById("mePill").textContent = "FORBIDDEN (mod/admin only)";
          setTimeout(() => (location.href = "/index.html"), 900);
          return false;
        }
        document.getElementById("mePill").textContent =
          `Logged in: ${me.user.fullName} (@${me.user.username}) [${me.user.role}]`;
        return true;
      }

      document.getElementById("logoutBtn").addEventListener("click", async () => {
        await fetch("/api/auth/logout", { method: "POST", credentials: "include" });
        location.href = "/login.html";
      });

      document.getElementById("submitFactBtn").addEventListener("click", async () => {
        const text = document.getElementById("factText").value.trim();
        if (!text) return setText("factStatus", "Type a fact first.");
        setText("factStatus", "Submitting…");
        try {
          await api("/api/facts/submit", { method: "POST", body: JSON.stringify({ text }) });
          document.getElementById("factText").value = "";
          setText("factStatus", "Submitted ✅ waiting for admin approval");
        } catch (e) {
          setText("factStatus", e.message || String(e));
        }
      });

      document.getElementById("sendBanReqBtn").addEventListener("click", async () => {
        const targetType = document.getElementById("banType").value;
        const userId = document.getElementById("banUserId").value.trim();
        const ip = document.getElementById("banIp").value.trim();
        const reason = document.getElementById("banReason").value.trim();

        if (!reason) return setText("banStatus", "Reason required.");
        if (targetType === "user" && !userId) return setText("banStatus", "User ID required.");
        if (targetType === "ip" && !ip) return setText("banStatus", "IP required.");

        setText("banStatus", "Sending…");
        try {
          await api("/api/mod/ban/request", {
            method: "POST",
            body: JSON.stringify({
              targetType,
              userId: targetType === "user" ? userId : null,
              ip: targetType === "ip" ? ip : null,
              reason
            })
          });
          document.getElementById("banReason").value = "";
          setText("banStatus", "Request sent ✅ admin will review");
        } catch (e) {
          setText("banStatus", e.message || String(e));
        }
      });

      (async () => { await guardMod(); })();
    </script>
  </body>
</html>
